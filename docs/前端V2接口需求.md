# 前端 V2 页面接口需求（按页面分组）

说明
- 基础路径：`/api/v1`
- 鉴权：HTTP Bearer（`Authorization: Bearer <token>`）
- 时间参数统一：`from`/`to`（ISO8601 或毫秒时间戳），`window`（如 `15m/1h/24h/7d`），`bucket`（`1m/5m/1h/1d`）
- 分页参数统一：`page`（默认1），`page_size`（默认20，最大100）
- 状态字段：启用=1，禁用=0
- 标注“[复用]”表示已存在或已在旧页使用；“[新增]”表示为 V2 新增的接口需求

---

## 1. 展示（总览）UsageOverviewV2

目标：展示一段时间内的总请求量、输入/输出 Token 总量、平均 Token/请求、峰值 QPS；并提供命名空间排行与时间序列趋势。

- [复用] 获取命名空间使用概览
  - GET `/namespaces/usage/overview`
  - Query：无（可扩展 `window`）
  - Response（示例）
    ```json
    {
      "total_namespaces": 3,
      "namespaces": [
        {
          "namespace_id": 1,
          "namespace_name": "微信服务",
          "namespace_code": "wechat",
          "usage": {
            "namespace_id": 1,
            "current_time": 1710000000,
            "time_window": "30m",
            "window_minutes": 30,
            "metrics": {
              "token_usage": {"current_usage": 12000, "max_limit": 50000, "usage_percentage": 24, "window_start": 1709998200, "window_end": 1710000000, "remaining": 38000},
              "qps_usage": {"current_usage": 120, "max_limit": 300, "usage_percentage": 40, "window_start": 1709998200, "window_end": 1710000000, "remaining": 180},
              "concurrent_usage": {"current_usage": 20, "max_limit": 100, "usage_percentage": 20, "remaining": 80}
            }
          }
        }
      ]
    }
    ```

- [新增] 获取总览汇总（总请求量、输入/输出 Token 总量、平均 Token/请求、峰值 QPS）
  - GET `/analytics/summary`
  - Query：`from`、`to`、`bucket`（可选）
  - Response（示例）
    ```json
    {
      "from": "2025-08-12T00:00:00Z",
      "to": "2025-08-12T01:00:00Z",
      "requests_total": 123456,
      "success_ratio": 0.985,
      "tokens_in_total": 987654,
      "tokens_out_total": 654321,
      "avg_tokens_in_per_req": 8.0,
      "avg_tokens_out_per_req": 5.3,
      "peak_qps": 143
    }
    ```

- [新增] 获取时间序列趋势（请求量、输入/输出 Token）
  - GET `/analytics/timeseries`
  - Query：`from`、`to`、`bucket`、`metrics=requests,tokens_in,tokens_out`
  - Response（示例）
    ```json
    {
      "bucket": "5m",
      "series": {
        "requests": [{"ts": 1710000000, "value": 1200}],
        "tokens_in": [{"ts": 1710000000, "value": 8000}],
        "tokens_out": [{"ts": 1710000000, "value": 5200}]
      }
    }
    ```

- [新增] 命名空间排行
  - GET `/analytics/namespaces/ranking`
  - Query：`from`、`to`、`metric`（`requests|tokens_in|tokens_out`）、`limit`（默认10）
  - Response（示例）
    ```json
    {
      "metric": "requests",
      "items": [
        {"namespace_id": 1, "namespace_code": "wechat", "namespace_name": "微信服务", "value": 34567, "ratio": 0.56, "wow": 0.12}
      ]
    }
    ```

---

## 2. 命名空间 NamespacesV2（含路由规则）

- [复用] 命名空间列表/详情/CRUD
  - GET `/namespaces`
  - GET `/namespaces/{id}`
  - POST `/namespaces`
  - PUT `/namespaces/{id}`
  - DELETE `/namespaces/{id}`
  - Body/Response：同现有 `docs/API接口清单.md`

- [复用] 命名空间路由规则（单条）
  - GET `/namespaces/{id}/route`
  - POST `/namespaces/{id}/route`（create or update）
  - DELETE `/namespaces/{id}/route`
  - Body（示例）
    ```json
    {
      "namespace_id": 1,
      "matcher_type": "header|body|query|path",
      "match_field": "channelcode",
      "match_operator": "eq|ne|gt|gte|lt|lte|contains|regex",
      "match_value": "wechat001"
    }
    ```
  - Response：路由规则对象（见旧文档）

---

## 3. 策略配置 PoliciesV2

- [复用] 规则类型
  - GET `/rules/types`
  - Response（示例）
    ```json
    {"rule_types": [{"type": "matcher", "name": "报文匹配", "description": "...", "config_schema": {}}]}
    ```

- [复用] 命名空间规则列表/CRUD
  - GET `/namespaces/{namespace_id}/rules`
  - GET `/rules/{rule_id}`
  - POST `/namespaces/{namespace_id}/rules`
  - PUT `/rules/{rule_id}`
  - DELETE `/rules/{rule_id}`
  - Body（示例，随 `rule_type` 变化）
    ```json
    {
      "namespace_id": 1,
      "rule_name": "VIP匹配",
      "rule_type": "matcher|token_limit|concurrent_limit|rate_limit",
      "rule_config": { "match_field": "user_type", "match_operator": "eq", "match_value": "VIP", "action": "allow" },
      "priority": 1,
      "status": 1
    }
    ```

---

## 4. 安全认证 AuthV2

说明：现有前端未集成认证凭据管理，以下为新增需求。

- [新增] 凭据列表（API Key/JWT/HMAC 等）
  - GET `/auth/credentials`
  - Query：`type`（`api_key|jwt|hmac|mtls`）、`namespace_id`、`status`、`page`、`page_size`
  - Response（示例）
    ```json
    {
      "page": 1,
      "page_size": 20,
      "total": 2,
      "items": [
        {"id": 101, "type": "api_key", "name": "mobile-app", "namespace_id": 1, "key_id": "k_abc", "expires_at": "2026-01-01T00:00:00Z", "status": 1, "last_used_at": "2025-08-11T09:00:00Z"}
      ]
    }
    ```

- [新增] 创建/更新/删除凭据
  - POST `/auth/credentials`
  - PUT `/auth/credentials/{id}`
  - DELETE `/auth/credentials/{id}`
  - Body（示例）
    ```json
    {
      "type": "api_key",
      "name": "mobile-app",
      "namespace_id": 1,
      "scopes": ["chat:read", "chat:write"],
      "expires_at": "2026-01-01T00:00:00Z",
      "status": 1
    }
    ```
  - Response：单个凭据对象（含生成的 `key_id/secret` 等，按类型返回）

- [新增] 验证/试用
  - POST `/auth/credentials/{id}/test`
  - Body：可选 `request` 示例，用于后端模拟校验
  - Response：`{"passed": true, "details": {...}}`

---

## 5. 流量监控 TrafficV2

- [新增] 流量汇总（请求数/成功率/4xx/5xx/限流/重试）
  - GET `/metrics/traffic/summary`
  - Query：`from`、`to`、`namespace_id`（可选）
  - Response（示例）
    ```json
    {
      "requests_total": 123456,
      "success_ratio": 0.983,
      "status_4xx": 123,
      "status_5xx": 45,
      "rate_limited": 67,
      "retried": 89
    }
    ```

- [新增] 流量时间序列（可多指标）
  - GET `/metrics/traffic/timeseries`
  - Query：`from`、`to`、`bucket`、`metrics=requests,success_ratio,status_4xx,status_5xx,rate_limited,retried`、`namespace_id`
  - Response（示例）
    ```json
    { "bucket": "1m", "series": { "requests": [{"ts": 1710000000, "value": 1200}] } }
    ```

- [新增] TopN（路径/上游/状态码）
  - GET `/metrics/traffic/topn`
  - Query：`from`、`to`、`by=path|upstream|status`、`limit=10`、`namespace_id`
  - Response（示例）
    ```json
    { "by": "path", "items": [{"key": "/v1/chat", "requests": 3456, "ratio": 0.23}]} 
    ```

---

## 6. 性能指标 MetricsV2

- [新增] 系统与节点指标概览
  - GET `/metrics/system/summary`
  - Response（示例）
    ```json
    {
      "nodes": [{"id": "gw-1", "cpu": 0.45, "mem": 0.62, "active_workers": 4, "connections": 320}],
      "gateway": {"requests_rate": 230.5, "queue_len": 2},
      "lua": {"mem_mb": 64.2},
      "shared_dict": {"used_pct": 0.61}
    }
    ```

- [新增] 依赖组件与上游健康
  - GET `/metrics/dependencies`
  - Response（示例）
    ```json
    {
      "redis": {"rtt_ms": 2.1, "hit_ratio": 0.93, "pool_in_use": 8},
      "mysql": {"pool_in_use": 3, "slow_queries": 1},
      "dns": {"success_ratio": 0.999},
      "upstreams": [{"id": 10, "name": "openai", "alive": true, "failures": 0, "last_check": "2025-08-12T01:00:00Z"}]
    }
    ```

- [新增] 指标时间序列
  - GET `/metrics/system/timeseries`
  - Query：`from`、`to`、`bucket`、`metrics=cpu,mem,requests_rate,lua_mem,redis_rtt,mysql_pool,...`
  - Response：同 timeseries 模式

---

## 7. 访问日志 LogsV2

- [新增] 日志检索
  - GET `/logs/search`
  - Query：
    - 时间：`from`、`to`
    - 过滤：`host`、`namespace_id`、`rule_id`、`path`（支持前缀/正则）
    - 其它：`method`、`status`、`trace_id`、`client_ip`、`api_key`、`min_duration_ms`、`max_duration_ms`
    - 分页：`page`、`page_size`
  - Response（示例）
    ```json
    {
      "page": 1,
      "page_size": 20,
      "total": 1024,
      "items": [
        {
          "id": "log_abc",
          "ts": "2025-08-12T01:00:00Z",
          "trace_id": "tr_xxx",
          "namespace_id": 1,
          "rule_id": 9,
          "method": "POST",
          "path": "/v1/chat",
          "status": 200,
          "upstream": "openai-1",
          "duration_ms": 320,
          "bytes": 2048,
          "rate_limited": false,
          "retries": 0,
          "client_ip": "10.0.0.1",
          "ua": "curl/8.1"
        }
      ]
    }
    ```

- [新增] 日志详情
  - GET `/logs/{id}`
  - Response（示例）
    ```json
    {
      "id": "log_abc",
      "ts": "2025-08-12T01:00:00Z",
      "request": {"headers": {"Authorization": "***"}, "query": {"app_id": "wx"}, "body": {"message": "hi"}},
      "response": {"headers": {"Content-Type": "application/json"}, "body": {"id": "cmpl-1"}},
      "namespace": {"id": 1, "code": "wechat", "name": "微信服务"},
      "rule": {"id": 9, "name": "聊天代理"},
      "upstream": {"id": 10, "name": "openai-1"},
      "metrics": {"duration_ms": 320, "tokens_in": 120, "tokens_out": 98, "retries": 0}
    }
    ```

- [新增] 导出
  - GET `/logs/export`
  - Query：与搜索一致，额外 `format=csv|json`
  - Response：文件流

---

## 8. 上游与代理（如 V2 页面需要沿用）

- [复用] 上游服务器 CRUD
  - GET `/upstream-servers`，GET `/upstream-servers/{id}`，POST `/upstream-servers`，PUT `/upstream-servers/{id}`，DELETE `/upstream-servers/{id}`

- [复用] 代理规则 CRUD
  - GET `/proxy-rules`，GET `/proxy-rules/{id}`，POST `/proxy-rules`，PUT `/proxy-rules/{id}`，DELETE `/proxy-rules/{id}`

---

## 9. 兼容与适配建议

- 若后端已有网关侧 `/stats`、`/health` 等，可通过 Config Center 聚合转发，统一在 `/api/v1` 提供上述 `analytics/metrics/logs` 入口。
- 新增接口建议以分页/时间窗为先，保证横向扩展；时间序列返回统一 `series[{ts,value}]` 结构。
- Token 统计口径需明确：是否包含失败请求、是否包含重试请求；建议字段化返回 `include_retries`、`include_non2xx`。

---

## 10. 错误响应（统一）

```json
{
  "detail": "error message",
  "code": "VALIDATION_ERROR",
  "trace_id": "tr_xxx"
}
```

---

如需，我可以据此更新 `src/services/api.ts`（或新增 `src/services/v2Api.ts`）的类型与方法骨架，便于前端直接接入。


