# 命名空间监控仪表盘功能说明

## 🎯 功能概述

命名空间监控仪表盘提供了实时监控每个命名空间配置的各种限制使用情况的功能，包括：

- **Token使用量监控**: 显示30分钟内（可配置）的输入token数量使用情况
- **QPS监控**: 显示每分钟请求数的使用情况
- **并发连接数监控**: 显示当前并发连接数的使用情况
- **实时数据更新**: 每30秒自动刷新数据
- **时间序列数据**: 提供历史使用情况的时间序列图表

## 📊 监控指标

### 1. Token使用量监控
- **监控内容**: 30分钟内（可配置时间窗口）的输入token数量
- **显示信息**:
  - 当前使用量 / 最大限制
  - 使用百分比
  - 剩余可用量
  - 时间窗口信息
- **数据来源**: Redis中的 `rate_limit:{namespace_id}:token:{window_start}` 键

### 2. QPS监控
- **监控内容**: 每分钟请求数的使用情况
- **显示信息**:
  - 当前使用量 / 最大限制
  - 使用百分比
  - 剩余可用量
  - 时间窗口信息
- **数据来源**: Redis中的 `rate_limit:{namespace_id}:qps:{window_start}` 键

### 3. 并发连接数监控
- **监控内容**: 当前并发连接数
- **显示信息**:
  - 当前连接数 / 最大连接数
  - 使用百分比
  - 剩余可用连接数
- **数据来源**: Redis中的 `concurrent:{namespace_id}:current` 键

## 🔧 技术实现

### 后端API接口

#### 1. 获取命名空间使用情况
```
GET /api/v1/namespaces/{namespace_id}/usage?time_window=30m
```

**响应示例**:
```json
{
  "namespace_id": 1,
  "namespace_name": "wechat",
  "namespace_code": "WECHAT_NS",
  "current_time": 1704067200,
  "time_window": "30m",
  "window_minutes": 30,
  "metrics": {
    "token_usage": {
      "current_usage": 5000,
      "max_limit": 10000,
      "usage_percentage": 50.0,
      "window_start": 1704067200,
      "window_end": 1704069000,
      "remaining": 5000
    },
    "qps_usage": {
      "current_usage": 45,
      "max_limit": 100,
      "usage_percentage": 45.0,
      "window_start": 1704067200,
      "window_end": 1704069000,
      "remaining": 55
    },
    "concurrent_usage": {
      "current_usage": 25,
      "max_limit": 50,
      "usage_percentage": 50.0,
      "remaining": 25
    }
  }
}
```

#### 2. 获取所有命名空间使用情况概览
```
GET /api/v1/namespaces/usage/overview
```

**响应示例**:
```json
{
  "total_namespaces": 3,
  "namespaces": [
    {
      "namespace_id": 1,
      "namespace_name": "wechat",
      "namespace_code": "WECHAT_NS",
      "usage": {
        // 同上
      }
    }
  ]
}
```

#### 3. 获取命名空间实时监控数据
```
GET /api/v1/namespaces/{namespace_id}/monitoring?metric_type=all
```

**响应示例**:
```json
{
  "namespace_id": 1,
  "current_time": 1704067200,
  "metrics": {
    "token_timeline": [
      {
        "timestamp": 1704063600,
        "usage": 3000,
        "time": "14:00"
      }
    ],
    "qps_timeline": [
      {
        "timestamp": 1704067200,
        "usage": 45,
        "time": "15:00"
      }
    ],
    "concurrent_timeline": [
      {
        "timestamp": 1704067200,
        "usage": 25,
        "time": "15:00"
      }
    ]
  }
}
```

### 前端组件

#### 1. 监控仪表盘页面
- **文件位置**: `frontend/src/pages/MonitoringDashboard.tsx`
- **功能特性**:
  - 实时数据展示
  - 自动刷新（每30秒）
  - 交互式图表
  - 多时间窗口选择
  - 错误处理和重试

#### 2. 主要组件
- **统计卡片**: 显示总命名空间数、活跃命名空间数、高使用率命名空间数
- **使用情况卡片**: 每个命名空间的使用情况概览
- **监控详情**: 选中命名空间的详细监控数据
- **时间序列图表**: 历史使用情况的时间序列展示

## 🎨 界面功能

### 1. 概览页面
- **统计信息**: 显示系统整体统计信息
- **命名空间列表**: 所有命名空间的使用情况卡片
- **实时更新**: 自动刷新数据

### 2. 详情页面
- **时间窗口选择**: 支持15分钟、30分钟、1小时、6小时、24小时
- **多指标展示**: Token、QPS、并发连接数的独立标签页
- **时间序列数据**: 表格形式展示历史数据

### 3. 交互功能
- **点击选择**: 点击命名空间卡片查看详情
- **手动刷新**: 点击刷新按钮手动更新数据
- **时间窗口切换**: 动态切换监控时间窗口

## 📈 数据流程

### 1. 数据收集
```
Gateway → Redis计数器 → 配置中心缓存 → 前端展示
```

### 2. 数据更新
- **实时更新**: Gateway在处理请求时实时更新Redis计数器
- **缓存更新**: 配置中心定期从Redis读取数据并缓存
- **前端刷新**: 前端每30秒自动刷新数据

### 3. 数据存储
- **Redis存储**: 所有计数器数据存储在Redis中
- **时间窗口**: 基于时间窗口的键值存储
- **自动过期**: Redis键自动过期，无需手动清理

## 🚀 使用示例

### 1. 查看wechat命名空间的使用情况

假设wechat命名空间配置了以下限制：
- 30分钟内最多输入10000个token
- 每分钟最多100个请求
- 最大并发连接数50个

**监控显示**:
```
命名空间: wechat (WECHAT_NS)
├── Token使用量: 5000/10000 (50.0%)
├── QPS使用量: 45/100 (45.0%)
└── 并发连接数: 25/50 (50.0%)
```

### 2. 时间序列数据示例

**Token使用量趋势**:
```
时间    使用量
14:00   3000
14:15   3500
14:30   4000
14:45   4500
15:00   5000
```

**QPS趋势**:
```
时间    使用量
14:55   40
15:00   45
15:01   42
15:02   48
15:03   45
```

## 🔍 监控场景

### 1. 正常使用场景
- 使用量在限制范围内
- 绿色进度条显示
- 系统运行正常

### 2. 高使用率场景
- 使用量接近限制（>80%）
- 橙色/红色进度条警告
- 需要关注系统负载

### 3. 超限场景
- 使用量超过限制
- 红色进度条警告
- 系统可能拒绝新请求

## 🛠️ 配置说明

### 1. 时间窗口配置
- **支持格式**: `15m`, `30m`, `1h`, `6h`, `24h`
- **默认值**: `30m`
- **配置位置**: 前端监控页面

### 2. 刷新频率配置
- **默认频率**: 30秒
- **配置位置**: `MonitoringDashboard.tsx` 中的 `useEffect`

### 3. 阈值配置
- **高使用率阈值**: 80%
- **警告颜色**: 橙色/红色
- **配置位置**: 前端组件中的条件判断

## 📋 部署说明

### 1. 后端部署
确保以下服务正常运行：
- 配置中心服务 (端口8000)
- Redis服务 (端口6379)
- MySQL数据库

### 2. 前端部署
确保以下依赖已安装：
- React 18+
- Ant Design 5+
- TypeScript

### 3. 访问地址
- **监控仪表盘**: `http://localhost:3000/monitoring`
- **API文档**: `http://localhost:8000/docs`

## 🧪 测试验证

### 1. 运行测试脚本
```bash
python test_monitoring_api.py
```

### 2. 手动测试
```bash
# 测试健康检查
curl http://localhost:8000/health

# 测试命名空间使用情况
curl http://localhost:8000/api/v1/namespaces/1/usage?time_window=30m

# 测试概览API
curl http://localhost:8000/api/v1/namespaces/usage/overview

# 测试监控数据API
curl http://localhost:8000/api/v1/namespaces/1/monitoring?metric_type=all
```

## 🔮 未来扩展

### 1. 图表增强
- 添加折线图、柱状图等可视化组件
- 支持多指标对比图表
- 添加趋势预测功能

### 2. 告警功能
- 使用率超过阈值时发送告警
- 支持邮件、短信、钉钉等多种告警方式
- 告警规则配置界面

### 3. 数据分析
- 历史数据分析报告
- 使用模式分析
- 容量规划建议

### 4. 权限控制
- 基于角色的访问控制
- 命名空间级别的权限管理
- 操作日志记录

## ✅ 总结

命名空间监控仪表盘提供了完整的实时监控功能，能够：

1. **实时监控**各种限制的使用情况
2. **可视化展示**使用量和趋势
3. **自动刷新**保持数据最新
4. **多维度分析**不同时间窗口的数据
5. **用户友好**的交互界面

这个功能大大提升了系统的可观测性，帮助运维人员及时了解系统使用情况，做出相应的调整和优化。 