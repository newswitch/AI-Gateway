# 智能网关需求文档

## 1. 项目概述

### 1.1 项目背景
智能网关是一个基于Nginx与Lua、Python技术栈构建的高性能AI服务网关，专门用于管理大模型服务的访问控制、负载均衡、流量监控和配置管理。

### 1.2 技术架构
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端管理界面    │    │   网关层        │    │   服务层        │
│   Vue 3 +       │◄──►│   Nginx +       │◄──►│   Python        │
│   Element Plus   │    │   OpenResty     │    │   微服务        │
└─────────────────┘    │   (Lua脚本)      │    │   - Token-count │
                       │   多实例集群      │    │   Service       │
                       └─────────────────┘    │   - Nacos        │
                                              └─────────────────┘
                                                       │
                       ┌─────────────────┐    ┌─────────────────┐
                       │   配置管理       │    │   存储层        │
                       │   Nacos         │    │   Redis         │
                       │   (配置中心)     │    │   (缓存/会话)   │
                       └─────────────────┘    └─────────────────┘
```

**架构组件说明：**
- **前端层**: Vue 3 + Element Plus (Web管理界面)
- **网关层**: Nginx + OpenResty (Lua脚本) - 支持多实例集群部署
- **服务层**: Python微服务架构
  - Token-count: Token计算和计费
  - Nacos: 配置管理、健康检查、监控统计 
- **存储层**: Redis (缓存/会话) 
- **监控**: 集成健康检查和监控功能

### 1.3 系统特点
- **高性能**: 基于Nginx的高并发处理能力
- **高可用**: 支持Nginx网关多实例集群部署
- **可扩展**: 微服务架构，支持水平扩展
- **可配置**: 基于Nacos的配置中心，支持动态配置
- **可监控**: 完整的监控和统计功能
- **多租户**: 支持多渠道、多模型的访问控制

## 2. 功能需求

### 2.1 前端层 (Vue 3 + Element Plus)

#### 2.1.1 配置管理功能
1. **规则配置管理**
   - 可以对所有配置进行修改
   - 对不同的报文字段可以设置不同的识别策略
   - 例如根据channelcode的值，匹配不同的规则
   - 或者报文中的maxtoken字段大于设定的值，就进行拒绝访问
   - 提供规则的增删改查操作

2. **渠道配置管理**
   - 渠道信息的增删改查
   - 渠道权限配置
   - 渠道配额设置
   - 渠道状态监控

3. **大模型配置管理**
   - 大模型服务信息配置
   - 大模型Token计算规则配置
   - 支持添加新大模型的计算规则
   - 大模型健康状态显示

4. **网关实例管理**
   - 网关实例的增删改查
   - 实例状态监控
   - 实例配置同步
   - 实例负载均衡配置

#### 2.1.2 监控展示功能
1. **健康检查监控**
   - 显示对于代理的大模型的健康检查
   - 实时健康状态更新
   - 健康检查历史记录

2. **Token使用统计**
   - 对每个渠道一个时间段内的输入输出token数量与已经使用的输入输出token数量进行显示
   - Token使用趋势图表
   - 配额使用率显示

3. **实时监控面板**
   - 系统整体状态概览
   - 各渠道实时请求量
   - 各模型响应时间统计
   - 异常告警信息

4. **网关集群监控**
   - 各网关实例状态监控
   - 实例间负载分布
   - 实例性能指标
   - 集群整体健康状态

#### 2.1.3 用户界面要求
- 响应式设计，支持多设备访问
- 直观的数据可视化展示
- 操作友好的配置界面
- 实时数据更新

### 2.2 网关层 (Nginx + OpenResty)

#### 2.2.1 多实例集群支持
1. **集群架构**
   - 支持Nginx网关多实例集群部署
   - 实例间配置自动同步
   - 实例健康检查和故障转移
   - 支持动态扩缩容

2. **负载均衡**
   - 前端负载均衡器（HAProxy/Nginx）分发请求
   - 支持多种负载均衡算法（轮询、权重、最小连接数）
   - 基于实例健康状态的智能路由
   - 会话保持机制

3. **配置同步**
   - 实例间配置实时同步
   - 配置变更广播机制
   - 配置版本一致性保证
   - 配置冲突解决策略

4. **高可用性**
   - 实例故障自动检测
   - 故障实例自动剔除
   - 新实例自动加入集群
   - 零停机配置更新

#### 2.2.2 请求处理功能
1. **请求识别与路由**
   - 可以根据接受的报文头或者报文请求体中的字段，进行筛选
   - 如根据报文头中channelcode的字段wechat001，wechat001是渠道码
   - 每个渠道可以配置不同的限制条件
   - 对限制连接数，请求数，某个时间段的最大输入，输出token数
   - 这些配置文件使用nacos进行配置，与存储

2. **访问控制**
   - 基于渠道码的访问控制
   - 每个渠道可配置不同的限制条件
   - 支持对大模型的连接数限制
   - 支持对请求数限制
   - 支持时间段内的Token数量限制

3. **分布式限流**
   - 支持跨实例的分布式限流
   - 基于Redis的限流计数器
   - 限流策略在实例间同步
   - 限流状态实时监控

#### 2.2.3 配置管理
1. **Nacos配置集成**
   - 所有配置规则存储在Nacos中
   - 支持配置的动态更新
   - 配置变更实时生效
   - 配置版本管理

2. **规则配置**
   - 可以对每个规则在nacos中进行渠道与渠道配置的增删改查
   - 支持复杂规则配置
   - 支持规则优先级设置
   - 支持规则模板管理

3. **实例配置管理**
   - 实例级别配置管理
   - 集群级别配置管理
   - 配置继承和覆盖机制
   - 配置验证和回滚

#### 2.2.4 流量控制
1. **Token限制**
   - 限制每个渠道在一段时间内对不同的大模型的访问的输入输出token数量限制
   - 限制token的时间段单位为10分钟
   - 可以限制10分钟为单位，例如10分钟可以输入10000token，20分钟可输入15000token
   - 支持灵活的时间段配置

2. **限流策略**
   - 基于时间窗口的限流
   - 基于Token消耗的限流
   - 基于请求频率的限流
   - 支持多种限流算法
   - 分布式限流协调

#### 2.2.5 健康检查
1. **后端服务健康检查**
   - 对后端大模型进行健康检查
   - 剔除不健康的实例
   - 支持多种健康检查方式
   - 健康检查结果缓存

2. **实例间健康检查**
   - 实例间心跳检测
   - 实例状态广播
   - 故障实例自动隔离
   - 实例恢复自动加入

3. **负载均衡**
   - 支持多种负载均衡算法
   - 基于健康状态的智能路由
   - 支持权重配置
   - 支持故障转移

#### 2.2.6 多模型代理
1. **模型路由**
   - 可以代理不同的大模型
   - 支持模型版本管理
   - 支持模型灰度发布
   - 支持模型A/B测试

2. **分布式代理**
   - 支持跨实例的模型代理
   - 代理状态在实例间同步
   - 代理负载均衡
   - 代理故障转移

### 2.3 服务层 (Python微服务)

#### 2.3.1 Token-count服务
1. **Token计算规则**
   - 根据不同的大模型有不同的计算规则
   - 支持多种Token计算算法
   - 支持自定义计算规则
   - 计算规则版本管理

2. **计费功能**
   - 基于Token消耗的计费
   - 支持多种计费模式
   - 计费数据实时统计
   - 计费历史记录

3. **规则管理**
   - 可以在前端中添加新大模型的计算规则
   - 规则配置的增删改查
   - 规则验证和测试
   - 规则发布和回滚



#### 2.3.2 Nacos配置管理服务
1. **配置管理**
   - 配置需要在nacos都可以进行配置
   - 配置的读取和更新
   - 配置变更通知
   - 配置同步机制
   - 配置备份和恢复

2. **健康检查服务**
   - 服务健康状态监控
   - 健康检查结果处理
   - 异常告警机制
   - 健康状态历史记录

3. **集群管理服务**
   - 网关实例注册和发现
   - 实例状态监控
   - 集群配置管理
   - 集群健康检查

### 2.4 存储层

#### 2.4.1 Redis存储
1. **缓存功能**
   - 每个渠道某段时间内使用的token数量存储在redis中
   - 配置信息缓存
   - 会话信息缓存
   - 健康检查结果缓存

2. **分布式存储**
   - 支持Redis集群部署
   - 数据分片和复制
   - 高可用性保证
   - 数据一致性保证

3. **数据结构设计**
   - 使用Hash存储渠道Token使用量
   - 使用Sorted Set存储时间序列数据
   - 使用String存储配置信息
   - 使用List存储日志信息
   - 使用Set存储实例信息

4. **数据过期策略**
   - 支持TTL设置
   - 自动清理过期数据
   - 数据持久化策略

### 2.5 监控层

#### 2.5.1 实时监控
1. **Token使用监控**
   - 显示每个渠道已使用的token数量
   - Token使用趋势分析
   - 配额使用率监控
   - 异常使用告警

2. **连接监控**
   - 显示每个渠道的连接数量
   - 连接状态监控
   - 连接池管理
   - 连接异常告警

3. **请求监控**
   - 显示每个渠道的请求数量
   - 请求成功率统计
   - 请求延迟监控
   - 请求异常分析

4. **集群监控**
   - 网关实例状态监控
   - 实例间通信监控
   - 集群整体性能监控
   - 集群故障告警

#### 2.5.2 模型监控
1. **模型性能监控**
   - 每个大模型接受的报文数量
   - 模型响应时间统计
   - 模型成功率监控
   - 模型负载监控

2. **性能指标**
   - QPS统计
   - 响应时间分布
   - 错误率统计
   - 资源使用率

#### 2.5.3 告警系统
1. **告警规则**
   - 可配置的告警阈值
   - 多种告警方式（邮件、短信、Webhook）
   - 告警级别管理
   - 告警抑制机制

2. **告警处理**
   - 告警确认机制
   - 告警升级策略
   - 告警历史记录
   - 告警统计分析

## 3. 非功能需求

### 3.1 性能需求
- **并发处理能力**: 支持10000+并发请求
- **响应时间**: 平均响应时间<100ms
- **吞吐量**: 支持1000+ QPS
- **可用性**: 99.9%以上
- **扩展性**: 支持水平扩展，新增实例无感知

### 3.2 高可用需求
- **故障恢复**: 单实例故障不影响整体服务
- **自动扩缩容**: 支持基于负载的自动扩缩容
- **零停机部署**: 支持滚动更新，零停机部署
- **数据一致性**: 多实例间数据一致性保证

### 3.3 安全需求
- **访问控制**: 基于角色的访问控制
- **数据加密**: 敏感数据加密存储
- **审计日志**: 完整的操作审计
- **防攻击**: DDoS防护、SQL注入防护

### 3.4 可扩展性需求
- **水平扩展**: 支持多实例部署
- **配置热更新**: 配置变更无需重启
- **插件机制**: 支持功能插件扩展
- **API版本管理**: 支持API版本控制

### 3.5 可维护性需求
- **日志管理**: 完整的日志记录和查询
- **监控告警**: 全面的监控和告警机制
- **备份恢复**: 数据备份和恢复机制
- **文档完善**: 详细的技术文档和操作手册

## 4. 技术实现细节

### 4.1 数据流设计
```
客户端请求 → 负载均衡器 → Nginx网关集群 → Lua脚本处理 → Python服务 → 大模型服务
                                    ↓
                                Nacos配置中心
                                    ↓
                                Redis集群
```

### 4.2 集群架构设计
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   负载均衡器     │    │   Nginx网关     │    │   Nginx网关     │
│   HAProxy       │───►│   实例1         │    │   实例2         │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                              │                        │
                       ┌─────────────────┐    ┌─────────────────┐
                       │   Nginx网关     │    │   Nginx网关     │
                       │   实例3         │    │   实例N         │
                       └─────────────────┘    └─────────────────┘
```

### 4.3 关键算法
1. **Token计算算法**: 支持GPT、Claude等多种模型的Token计算
2. **限流算法**: 令牌桶、漏桶算法
3. **负载均衡算法**: 轮询、权重、最小连接数
4. **健康检查算法**: 心跳检测、响应时间检测
5. **分布式一致性算法**: 基于Redis的分布式锁和一致性保证

### 4.4 配置管理
1. **配置结构**: 采用JSON格式的配置结构
2. **配置验证**: 配置变更前的格式验证
3. **配置同步**: 多实例间的配置同步机制
4. **配置备份**: 配置的自动备份和恢复

## 5. 部署架构

### 5.1 生产环境部署
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   负载均衡器     │    │   Nginx网关     │    │   Python服务    │
│   HAProxy       │───►│   集群          │───►│   集群          │
│   集群          │    │   (多实例)      │    │   (多实例)      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                              │                        │
                       ┌─────────────────┐    ┌─────────────────┐
                       │   Nacos集群     │    │   Redis集群     │
                       └─────────────────┘    └─────────────────┘
```

### 5.2 监控部署
- **Prometheus**: 指标收集
- **Grafana**: 监控面板
- **AlertManager**: 告警管理
- **ELK Stack**: 日志分析

## 6. 测试策略

### 6.1 功能测试
- 单元测试覆盖率达到80%以上
- 集成测试覆盖主要业务流程
- 端到端测试验证完整功能
- 集群功能测试

### 6.2 性能测试
- 压力测试验证系统性能
- 负载测试验证系统稳定性
- 容量测试确定系统容量
- 集群性能测试

### 6.3 安全测试
- 渗透测试验证系统安全性
- 代码安全扫描
- 配置安全审计

### 6.4 高可用测试
- 故障恢复测试
- 自动扩缩容测试
- 零停机部署测试

## 7. 项目计划

### 7.1 开发阶段
1. **第一阶段**: 基础架构搭建（2周）
2. **第二阶段**: 核心功能开发（4周）
3. **第三阶段**: 集群功能开发（3周）
4. **第四阶段**: 前端界面开发（3周）
5. **第五阶段**: 测试和优化（2周）
6. **第六阶段**: 部署和上线（1周）

### 7.2 里程碑
- **M1**: 基础架构完成
- **M2**: 核心功能完成
- **M3**: 集群功能完成
- **M4**: 前端界面完成
- **M5**: 系统测试完成
- **M6**: 生产环境上线

## 8. 风险评估

### 8.1 技术风险
- **性能风险**: 高并发场景下的性能问题
- **兼容性风险**: 不同大模型API的兼容性问题
- **稳定性风险**: 系统长时间运行的稳定性
- **集群风险**: 多实例间的一致性和同步问题

### 8.2 业务风险
- **需求变更风险**: 业务需求的频繁变更
- **时间风险**: 项目进度延期风险
- **资源风险**: 开发资源不足的风险

### 8.3 风险应对策略
- 建立完善的测试体系
- 采用敏捷开发模式
- 建立风险监控机制
- 制定应急预案
- 分阶段实施集群功能 