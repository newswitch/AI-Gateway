# AIç½‘å…³ç›‘æ§ç³»ç»Ÿä½¿ç”¨è¯´æ˜

## ğŸ“Š ç³»ç»Ÿæ¶æ„

```
RedisæŒ‡æ ‡å­˜å‚¨ â†’ Prometheusæ”¶é›† â†’ Grafanaå¯è§†åŒ–
```

## ğŸš€ å¿«é€Ÿå¯åŠ¨

### 1. å¯åŠ¨ç›‘æ§ç³»ç»Ÿ
```bash
# ä¸€é”®å¯åŠ¨æ‰€æœ‰æœåŠ¡
start-monitoring.bat

# æˆ–æ‰‹åŠ¨å¯åŠ¨
docker-compose -f docker-compose.dev.yml up -d
```

### 2. è®¿é—®ç›‘æ§ç•Œé¢
- **Prometheus**: http://localhost:9090
- **Grafana**: http://localhost:3001 (admin/admin123)

## ğŸ“ˆ ç›‘æ§æ•°æ®æ¥æº

### Redisä¸­çš„æŒ‡æ ‡æ•°æ®
ç³»ç»Ÿè‡ªåŠ¨å°†ä»¥ä¸‹æ•°æ®å­˜å‚¨åˆ°Redisä¸­ï¼š

#### å…¨å±€æŒ‡æ ‡
- `metrics:global:total_requests` - æ€»è¯·æ±‚æ•°
- `metrics:global:total_errors` - æ€»é”™è¯¯æ•°
- `metrics:global:total_response_time` - æ€»å“åº”æ—¶é—´
- `metrics:global:last_request_time` - æœ€åè¯·æ±‚æ—¶é—´

#### å‘½åç©ºé—´æŒ‡æ ‡
- `metrics:ns:{namespace_code}:total_requests` - å‘½åç©ºé—´è¯·æ±‚æ•°
- `metrics:ns:{namespace_code}:successful_requests` - æˆåŠŸè¯·æ±‚æ•°
- `metrics:ns:{namespace_code}:failed_requests` - å¤±è´¥è¯·æ±‚æ•°
- `metrics:ns:{namespace_code}:total_response_time` - å“åº”æ—¶é—´
- `metrics:ns:{namespace_code}:concurrent_requests` - å¹¶å‘è¯·æ±‚æ•°
- `metrics:ns:{namespace_code}:status:{status_code}` - çŠ¶æ€ç ç»Ÿè®¡

#### å®ä¾‹å¥åº·çŠ¶æ€
- `metrics:instance:{instance_id}:{namespace_code}` - å®ä¾‹å¥åº·çŠ¶æ€

### Prometheusè‡ªåŠ¨æ”¶é›†
Prometheusæ¯15ç§’ä»ä»¥ä¸‹æœåŠ¡æ”¶é›†æŒ‡æ ‡ï¼š

1. **AI Gateway** (ç«¯å£8080)
   - è·¯å¾„: `/metrics`
   - æ¥æº: Luaè„šæœ¬ç”Ÿæˆçš„æŒ‡æ ‡

2. **é…ç½®ä¸­å¿ƒ** (ç«¯å£8000)
   - è·¯å¾„: `/metrics`
   - æ¥æº: PythonæœåŠ¡æŒ‡æ ‡

3. **TokenæœåŠ¡** (ç«¯å£8000)
   - è·¯å¾„: `/metrics`
   - æ¥æº: Tokenè®¡ç®—æŒ‡æ ‡

## ğŸ¯ ç›‘æ§ä»ªè¡¨ç›˜

### 1. AIç½‘å…³æ€»è§ˆ
- è¯·æ±‚ç‡è¶‹åŠ¿
- æ€»è¯·æ±‚æ•°ç»Ÿè®¡
- å“åº”æ—¶é—´è¶‹åŠ¿
- å‘½åç©ºé—´å¹¶å‘è¯·æ±‚
- è¯·æ±‚åˆ†å¸ƒ
- çŠ¶æ€ç åˆ†å¸ƒ

### 2. å‘½åç©ºé—´ç›‘æ§
- æŒ‰å‘½åç©ºé—´ç­›é€‰
- å‘½åç©ºé—´è¯·æ±‚ç‡
- å‘½åç©ºé—´å“åº”æ—¶é—´
- å¹¶å‘è¯·æ±‚æ•°
- çŠ¶æ€ç åˆ†å¸ƒ
- Tokenä½¿ç”¨é‡

### 3. æ¨¡å‹ç›‘æ§
- æ¨¡å‹è¯·æ±‚ç‡
- æ¨¡å‹å“åº”æ—¶é—´P95
- Tokenä½¿ç”¨é‡ï¼ˆè¾“å…¥/è¾“å‡ºï¼‰
- æˆæœ¬ç»Ÿè®¡
- é”™è¯¯ç»Ÿè®¡

## ğŸ”§ é…ç½®è¯´æ˜

### Prometheusé…ç½®
ä½¿ç”¨ `monitoring/prometheus.yml` é…ç½®æ–‡ä»¶ï¼š
- æŠ“å–é—´éš”: 15ç§’
- è¯„ä¼°é—´éš”: 15ç§’
- æ•°æ®ä¿ç•™: 30å¤©

### Grafanaé…ç½®
- æ•°æ®æº: è‡ªåŠ¨è¿æ¥åˆ°Prometheus
- ä»ªè¡¨ç›˜: è‡ªåŠ¨åŠ è½½é¢„é…ç½®çš„ä»ªè¡¨ç›˜
- åˆ·æ–°é—´éš”: 30ç§’

## ğŸ“Š å¸¸ç”¨æŸ¥è¯¢

### åœ¨Prometheusä¸­æŸ¥è¯¢
è®¿é—® http://localhost:9090ï¼Œåœ¨æŸ¥è¯¢æ¡†ä¸­è¾“å…¥ï¼š

```promql
# æ€»è¯·æ±‚ç‡
sum(rate(ai_gateway_requests_total[5m]))

# æŒ‰å‘½åç©ºé—´åˆ†ç»„çš„è¯·æ±‚ç‡
sum(rate(ai_gateway_namespace_requests_total[5m])) by (namespace_code)

# å¹³å‡å“åº”æ—¶é—´
ai_gateway_response_time_seconds

# é”™è¯¯ç‡
sum(rate(ai_gateway_errors_total[5m])) / sum(rate(ai_gateway_requests_total[5m])) * 100
```

### åœ¨Grafanaä¸­æŸ¥çœ‹
1. è¿›å…¥ "Dashboards" â†’ "AI Gateway"
2. é€‰æ‹©ç›¸åº”çš„ç›‘æ§ä»ªè¡¨ç›˜
3. ä½¿ç”¨å˜é‡ç­›é€‰å™¨æŸ¥çœ‹ç‰¹å®šæ•°æ®

## ğŸ› ï¸ æ•…éšœæ’é™¤

### 1. æ•°æ®ä¸æ˜¾ç¤º
- æ£€æŸ¥Redisè¿æ¥: `docker logs ai-gateway-redis-dev`
- æ£€æŸ¥PrometheusçŠ¶æ€: http://localhost:9090/targets
- æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€: `docker-compose -f docker-compose.dev.yml ps`

### 2. æŒ‡æ ‡ç¼ºå¤±
- æ£€æŸ¥Luaè„šæœ¬: `docker logs ai-gateway-gateway-dev`
- æ£€æŸ¥PythonæœåŠ¡: `docker logs ai-gateway-config-center-dev`
- æ£€æŸ¥TokenæœåŠ¡: `docker logs ai-gateway-token-service-dev`

### 3. Grafanaæ— æ³•è®¿é—®
- æ£€æŸ¥GrafanaçŠ¶æ€: `docker logs ai-gateway-grafana-dev`
- ç¡®è®¤ç«¯å£3001æœªè¢«å ç”¨
- æ£€æŸ¥ç½‘ç»œè¿æ¥

## ğŸ“ ç›‘æ§æŒ‡æ ‡è¯´æ˜

### ç½‘å…³æŒ‡æ ‡
- `ai_gateway_requests_total`: æ€»è¯·æ±‚æ•°
- `ai_gateway_errors_total`: æ€»é”™è¯¯æ•°
- `ai_gateway_response_time_seconds`: å¹³å‡å“åº”æ—¶é—´
- `ai_gateway_uptime_seconds`: è¿è¡Œæ—¶é—´

### å‘½åç©ºé—´æŒ‡æ ‡
- `ai_gateway_namespace_requests_total`: å‘½åç©ºé—´è¯·æ±‚æ•°
- `ai_gateway_namespace_concurrent_requests`: å‘½åç©ºé—´å¹¶å‘è¯·æ±‚æ•°
- `ai_gateway_namespace_response_time_seconds`: å‘½åç©ºé—´å“åº”æ—¶é—´
- `ai_gateway_namespace_status_codes_total`: å‘½åç©ºé—´çŠ¶æ€ç ç»Ÿè®¡

### æ¨¡å‹æŒ‡æ ‡
- `model_requests_total`: æ¨¡å‹è¯·æ±‚æ•°
- `model_request_duration_seconds`: æ¨¡å‹è¯·æ±‚è€—æ—¶
- `model_tokens_input_total`: è¾“å…¥Tokenæ•°
- `model_tokens_output_total`: è¾“å‡ºTokenæ•°
- `model_cost_usd_total`: æ¨¡å‹æˆæœ¬
- `model_errors_total`: æ¨¡å‹é”™è¯¯æ•°

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [AIç½‘å…³æ¶æ„è¯´æ˜](./AI_Gateway_æ¶æ„å›¾è¯´æ˜.md)
- [Redisç¼“å­˜ç»“æ„è¯´æ˜](../config-center/Redisç¼“å­˜ç»“æ„è¯´æ˜.md)
- [Prometheusé…ç½®](../monitoring/prometheus.yml)
