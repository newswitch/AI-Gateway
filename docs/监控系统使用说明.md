# AI网关监控系统使用说明

## 📊 系统架构

```
Redis指标存储 → Prometheus收集 → Grafana可视化
```

## 🚀 快速启动

### 1. 启动监控系统
```bash
# 一键启动所有服务
start-monitoring.bat

# 或手动启动
docker-compose -f docker-compose.dev.yml up -d
```

### 2. 访问监控界面
- **Prometheus**: http://localhost:9090
- **Grafana**: http://localhost:3001 (admin/admin123)

## 📈 监控数据来源

### Redis中的指标数据
系统自动将以下数据存储到Redis中：

#### 全局指标
- `metrics:global:total_requests` - 总请求数
- `metrics:global:total_errors` - 总错误数
- `metrics:global:total_response_time` - 总响应时间
- `metrics:global:last_request_time` - 最后请求时间

#### 命名空间指标
- `metrics:ns:{namespace_code}:total_requests` - 命名空间请求数
- `metrics:ns:{namespace_code}:successful_requests` - 成功请求数
- `metrics:ns:{namespace_code}:failed_requests` - 失败请求数
- `metrics:ns:{namespace_code}:total_response_time` - 响应时间
- `metrics:ns:{namespace_code}:concurrent_requests` - 并发请求数
- `metrics:ns:{namespace_code}:status:{status_code}` - 状态码统计

#### 实例健康状态
- `metrics:instance:{instance_id}:{namespace_code}` - 实例健康状态

### Prometheus自动收集
Prometheus每15秒从以下服务收集指标：

1. **AI Gateway** (端口8080)
   - 路径: `/metrics`
   - 来源: Lua脚本生成的指标

2. **配置中心** (端口8000)
   - 路径: `/metrics`
   - 来源: Python服务指标

3. **Token服务** (端口8000)
   - 路径: `/metrics`
   - 来源: Token计算指标

## 🎯 监控仪表盘

### 1. AI网关总览
- 请求率趋势
- 总请求数统计
- 响应时间趋势
- 命名空间并发请求
- 请求分布
- 状态码分布

### 2. 命名空间监控
- 按命名空间筛选
- 命名空间请求率
- 命名空间响应时间
- 并发请求数
- 状态码分布
- Token使用量

### 3. 模型监控
- 模型请求率
- 模型响应时间P95
- Token使用量（输入/输出）
- 成本统计
- 错误统计

## 🔧 配置说明

### Prometheus配置
使用 `monitoring/prometheus.yml` 配置文件：
- 抓取间隔: 15秒
- 评估间隔: 15秒
- 数据保留: 30天

### Grafana配置
- 数据源: 自动连接到Prometheus
- 仪表盘: 自动加载预配置的仪表盘
- 刷新间隔: 30秒

## 📊 常用查询

### 在Prometheus中查询
访问 http://localhost:9090，在查询框中输入：

```promql
# 总请求率
sum(rate(ai_gateway_requests_total[5m]))

# 按命名空间分组的请求率
sum(rate(ai_gateway_namespace_requests_total[5m])) by (namespace_code)

# 平均响应时间
ai_gateway_response_time_seconds

# 错误率
sum(rate(ai_gateway_errors_total[5m])) / sum(rate(ai_gateway_requests_total[5m])) * 100
```

### 在Grafana中查看
1. 进入 "Dashboards" → "AI Gateway"
2. 选择相应的监控仪表盘
3. 使用变量筛选器查看特定数据

## 🛠️ 故障排除

### 1. 数据不显示
- 检查Redis连接: `docker logs ai-gateway-redis-dev`
- 检查Prometheus状态: http://localhost:9090/targets
- 检查服务健康状态: `docker-compose -f docker-compose.dev.yml ps`

### 2. 指标缺失
- 检查Lua脚本: `docker logs ai-gateway-gateway-dev`
- 检查Python服务: `docker logs ai-gateway-config-center-dev`
- 检查Token服务: `docker logs ai-gateway-token-service-dev`

### 3. Grafana无法访问
- 检查Grafana状态: `docker logs ai-gateway-grafana-dev`
- 确认端口3001未被占用
- 检查网络连接

## 📝 监控指标说明

### 网关指标
- `ai_gateway_requests_total`: 总请求数
- `ai_gateway_errors_total`: 总错误数
- `ai_gateway_response_time_seconds`: 平均响应时间
- `ai_gateway_uptime_seconds`: 运行时间

### 命名空间指标
- `ai_gateway_namespace_requests_total`: 命名空间请求数
- `ai_gateway_namespace_concurrent_requests`: 命名空间并发请求数
- `ai_gateway_namespace_response_time_seconds`: 命名空间响应时间
- `ai_gateway_namespace_status_codes_total`: 命名空间状态码统计

### 模型指标
- `model_requests_total`: 模型请求数
- `model_request_duration_seconds`: 模型请求耗时
- `model_tokens_input_total`: 输入Token数
- `model_tokens_output_total`: 输出Token数
- `model_cost_usd_total`: 模型成本
- `model_errors_total`: 模型错误数

## 🔗 相关文档

- [AI网关架构说明](./AI_Gateway_架构图说明.md)
- [Redis缓存结构说明](../config-center/Redis缓存结构说明.md)
- [Prometheus配置](../monitoring/prometheus.yml)
