# AI Gateway 架构图说明

## 🏗️ 整体架构图

### 1. 系统层次结构

```
┌─────────────────────────────────────────────────────────────────┐
│                        用户层 (User Layer)                        │
├─────────────────────────────────────────────────────────────────┤
│  Web前端 (React)     │  API客户端     │  管理界面     │  监控面板    │
│  localhost:3000     │  HTTP/HTTPS   │  Dashboard   │  Grafana    │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                     网关层 (Gateway Layer)                        │
├─────────────────────────────────────────────────────────────────┤
│                    OpenResty/Nginx Gateway                      │
│                    localhost:8080                              │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                Lua 脚本模块                              │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐      │   │
│  │  │ 路由匹配    │ │ 策略执行    │ │ 监控指标    │      │   │
│  │  │ namespace   │ │ policy      │ │ metrics     │      │   │
│  │  │ matcher     │ │ enforcer    │ │ collector   │      │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘      │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐      │   │
│  │  │ 上游选择    │ │ 代理转发    │ │ 健康检查    │      │   │
│  │  │ upstream    │ │ proxy       │ │ health      │      │   │
│  │  │ selector    │ │ handler     │ │ checker     │      │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘      │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    服务层 (Service Layer)                        │
├─────────────────────────────────────────────────────────────────┤
│  配置中心 (FastAPI)  │  Token服务     │  上游AI服务    │  数据库层   │
│  localhost:8001     │  localhost:8002│  OpenAI/其他   │  MySQL/Redis│
│  ┌─────────────┐   │  ┌─────────┐   │  ┌─────────┐   │  ┌──────┐  │
│  │ 命名空间管理│   │  │ Token   │   │  │ GPT-4   │   │  │MySQL │  │
│  │ 策略配置    │   │  │ 计算    │   │  │ Claude  │   │  │Redis │  │
│  │ 路由规则    │   │  │ 服务    │   │  │ 其他模型│   │  │缓存  │  │
│  └─────────────┘   │  └─────────┘   │  └─────────┘   │  └──────┘  │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                   监控层 (Monitoring Layer)                      │
├─────────────────────────────────────────────────────────────────┤
│  Prometheus        │  Redis缓存      │  日志系统      │  告警系统   │
│  localhost:9090    │  localhost:6379 │  Nginx日志     │  AlertManager│
│  ┌─────────────┐   │  ┌─────────┐   │  ┌─────────┐   │  ┌──────┐  │
│  │ 指标收集    │   │  │ 实时数据│   │  │ 访问日志│   │  │ 告警 │  │
│  │ 时间序列    │   │  │ 缓存    │   │  │ 错误日志│   │  │ 通知 │  │
│  │ 数据存储    │   │  │ 限流    │   │  │ 审计日志│   │  │ 规则 │  │
│  └─────────────┘   │  └─────────┘   │  └─────────┘   │  └──────┘  │
└─────────────────────────────────────────────────────────────────┘
```

## 🔄 数据流向图

### 1. 请求处理流程

```
用户请求 → Nginx Gateway → Lua脚本处理 → 策略检查 → 上游转发 → 响应返回
    │           │              │           │           │
    │           │              │           │           │
    ▼           ▼              ▼           ▼           ▼
  HTTP     路由匹配        命名空间匹配   策略执行    代理转发
 请求      namespace      namespace     policy      upstream
          matcher        matcher       enforcer    handler
    │           │              │           │           │
    │           │              │           │           │
    ▼           ▼              ▼           ▼           ▼
  监控指标    Redis缓存      配置中心      Token服务    AI服务
 收集      config_cache    config-center  token-service  OpenAI
    │           │              │           │           │
    │           │              │           │           │
    ▼           ▼              ▼           ▼           ▼
/metrics    指标存储        策略配置       Token计算    模型响应
端点        rate_limit      policies      tokens       response
```

### 2. 监控数据流

```
Lua脚本 → Redis存储 → Nginx /metrics → Prometheus → 查询/告警
   │         │            │              │
   │         │            │              │
   ▼         ▼            ▼              ▼
指标收集   实时缓存     指标暴露        时间序列
metrics   cache       /metrics        TSDB
   │         │            │              │
   │         │            │              │
   ▼         ▼            ▼              ▼
请求计数   配置缓存      Prometheus      Grafana
响应时间  限流数据       拉取收集        可视化
错误统计  会话数据       指标聚合        监控面板
```

## 🏛️ 组件详细架构

### 1. Gateway 内部架构

```
┌─────────────────────────────────────────────────────────────┐
│                    OpenResty/Nginx Gateway                  │
├─────────────────────────────────────────────────────────────┤
│  Nginx 配置层                                               │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  nginx.conf                                        │   │
│  │  - 端口监听 (8080)                                 │   │
│  │  - 路由配置                                        │   │
│  │  - 共享内存                                        │   │
│  │  - Lua模块加载                                     │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  Lua 脚本层                                                │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  core/init.lua          - 核心初始化                │   │
│  │  auth/namespace_matcher  - 命名空间匹配              │   │
│  │  auth/policy_enforcer    - 策略执行                 │   │
│  │  routing/router          - 路由处理                 │   │
│  │  routing/upstream_selector - 上游选择               │   │
│  │  routing/proxy_handler   - 代理转发                 │   │
│  │  monitoring/metrics      - 指标收集                 │   │
│  │  monitoring/health       - 健康检查                 │   │
│  │  monitoring/logger       - 日志记录                 │   │
│  │  utils/redis             - Redis工具                │   │
│  │  utils/http              - HTTP工具                 │   │
│  │  utils/json              - JSON工具                 │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 2. 监控系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                    监控系统架构                              │
├─────────────────────────────────────────────────────────────┤
│  数据收集层                                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Lua脚本指标收集                                    │   │
│  │  - 请求计数 (gateway_requests_total)                │   │
│  │  - 响应时间 (gateway_request_duration_seconds)      │   │
│  │  - 错误统计 (gateway_requests_failed_total)         │   │
│  │  - 上游指标 (gateway_upstream_requests_total)       │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  数据存储层                                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Redis缓存          │  Prometheus TSDB              │   │
│  │  - 实时数据         │  - 时间序列数据                │   │
│  │  - 配置缓存         │  - 历史数据                    │   │
│  │  - 限流数据         │  - 指标聚合                    │   │
│  │  - 会话数据         │  - 查询接口                    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  数据暴露层                                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Nginx /metrics 端点                                │   │
│  │  - Prometheus格式                                   │   │
│  │  - 实时指标                                         │   │
│  │  - 标签支持                                         │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  数据消费层                                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Prometheus         │  Grafana                      │   │
│  │  - 指标拉取         │  - 可视化                     │   │
│  │  - 数据存储         │  - 仪表盘                     │   │
│  │  - 查询接口         │  - 告警                       │   │
│  │  - 告警规则         │  - 监控                       │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

## 🔧 Draw.io 绘制指南

### 1. 创建新图表
1. 打开 [Draw.io](https://app.diagrams.net/)
2. 选择 "Create New Diagram"
3. 选择 "Blank Diagram"

### 2. 添加组件
使用以下形状和颜色：

#### 用户层 (浅蓝色)
- **矩形**: Web前端、API客户端、管理界面
- **文字**: 端口号 (localhost:3000, localhost:8080)

#### 网关层 (绿色)
- **大矩形**: OpenResty/Nginx Gateway
- **小矩形**: Lua脚本模块
- **文字**: 功能描述

#### 服务层 (黄色)
- **矩形**: 配置中心、Token服务、上游AI服务
- **圆柱体**: 数据库 (MySQL、Redis)
- **文字**: 端口号和功能

#### 监控层 (橙色)
- **矩形**: Prometheus、Grafana
- **圆柱体**: Redis缓存
- **文字**: 端口号和功能

### 3. 连接线
- **实线箭头**: 数据流向
- **虚线**: 配置关系
- **不同颜色**: 不同类型的连接

### 4. 标签和说明
- **端口号**: 每个服务旁边标注端口
- **功能描述**: 简要说明每个组件的作用
- **数据流向**: 用箭头表示数据流向

### 5. 布局建议
- **从上到下**: 用户层 → 网关层 → 服务层 → 监控层
- **从左到右**: 相关组件水平排列
- **分组**: 使用背景色或边框分组相关组件

## 📊 关键指标说明

### 1. 业务指标
- `gateway_requests_total`: 总请求数
- `gateway_requests_success_total`: 成功请求数
- `gateway_requests_failed_total`: 失败请求数

### 2. 性能指标
- `gateway_request_duration_seconds`: 请求持续时间
- `gateway_upstream_duration_seconds`: 上游响应时间

### 3. 系统指标
- `gateway_up_time_seconds`: 网关运行时间
- `gateway_upstream_requests_total`: 上游请求数

## 🎯 架构特点

1. **微服务架构**: 各组件独立部署
2. **动态配置**: 通过配置中心管理
3. **实时监控**: 完整的监控体系
4. **高可用**: 支持负载均衡和故障转移
5. **可扩展**: 支持水平扩展

这个架构图展示了 AI Gateway 的完整技术栈和数据流向，您可以根据这个描述在 Draw.io 中创建专业的架构图！
